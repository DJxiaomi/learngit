{set:
	$myCartObj  = new Cart();
	$myCartInfo = $myCartObj->getMyCart();
	$siteConfig = new Config("site_config");
	$callback   = IReq::get('callback') ? urlencode(IFilter::act(IReq::get('callback'),'url')) : '';
    $this->defaultAddressId = ( $this->defaultAddressId ) ? $this->defaultAddressId : ( $this->addressList ) ? $this->addressList[0]['id'] : 0;
}
{js:my97date}
{js:artTemplate}
<link href="{skin:css/cart.css}" rel="stylesheet" type="text/css" />
<style>
.list_table input[type=text], .list_table select {width: auto;}
.notice {margin-left:0px;margin-top:15px;}
.notice b {color:red;font-size:12px;}
.teaching_time2 {padding-left:3%;font-size:100%;}
.teaching_time2 select, .teaching_time2 input {width:auto;}
.teaching_time2 input {border:1px solid #666;height:22px;line-height:22px; width: 80px;}
.list_table input {height: 25px; padding: 0px; border: 1px solid #ccc;}
.list_table tr {height: 28px; line-height: 28px;}
.form_table2 { border-bottom: 1px solid #f4f4f4; margin-bottom: 8px;}
.form_table2 th {width: 79px;}
.form_table2 td input {width: 60px; font-size: 100%; text-indent: 3px;}
.mui-card .mui-card-content, .mui-card .mui-table-view, .mui-media {background-color:#fff;}
.dqk_discount {margin: 5px 0 8px 0;text-align:right;margin-right:5%;}
.dqk_cart_info .t-left {float: left;font-size:.8rem;color:#666;}
.dqk_cart_info .t-right {float:right;font-size:.8rem;color:#666;}
.dqk_cart_info .mui-media-body {margin-left:5%;width:90%;padding-top:6px;overflow:hidden;}
.dqk_cart_info .red2 {font-size:1.3rem;}
</style>
<script type='text/javascript' src='{theme:javascript/orderFormClass.js}'></script>
<form action='{url:/simple/cart31}' method='post' name='order_form' id="order_form">
	<input type='hidden' name='timeKey' value='{echo:time()}' />
	<input type='hidden' name='direct_gid' value='{$this->gid}' />
	<input type='hidden' name='direct_type' value='{$this->type}' />
	<input type='hidden' name='direct_num' id="direct_num" value='{$this->num}' />
	<input type='hidden' name='direct_promo' value='{$this->promo}' />
	<input type='hidden' name='direct_active_id' value='{$this->active_id}' />
	<input type='hidden' name='takeself' value='0' />
	<input type='hidden' name='dprice' value='{$this->dprice}' />
	<input type='hidden' name='stime' value='{$this->stime}' />
	<input type='hidden' name='statement' value='{$this->statement}' />
	<input type="hidden" name="ischit" value="{$this->ischit}" />
	<input type="hidden" name="chitid" value="{$this->chitid}" />
	<input type="hidden" name="seller_tutor_id" value="{$this->seller_tutor_id}" />
	<input type="hidden" name="user_tutor_id" value="{$this->user_tutor_id}" />
	<input type="hidden" name="seller_id" value="{$this->seller_id}" />
	<input type="hidden" name="zuhe_id" value="{$this->zuhe_id}" />
	<h5 class="mui-content-padded">联系人：</h5>
	<div class="mui-card">
		<div class="mui-input-group" id="address_form">
			{foreach:items=$this->addressList}
			<div class="mui-input-row mui-radio mui-left">
				<label>{$item['accept_name']}&nbsp;&nbsp;{$item['mobile']}</label>
				<input name="radio_address" type="radio" value="{$item['id']}" onclick='orderFormInstance.addressSelected({echo:JSON::encode($item)});' data-json='{echo:JSON::encode($item)}'>
			</div>
	        {/foreach}
	        <div class="mui-input-row mui-radio mui-left">
				<label>新联系人</label>
				<input name="radio_address" type="radio" value="" onclick='orderFormInstance.addressEmpty();'>
			</div>
			<div class="addr_list" id="acceptbox" style="display:none;">
				<div class="mui-input-row">
					<!-- <label>联系人姓名</label> -->
					<input type="text" class="mui-input-clear mui-input" id="accept_name" name="accept_name" value="" placeholder="姓名" />
				</div>
				<div class="mui-input-row">
					<!-- <label>手机号码</label> -->
					<input type="text" class="mui-input-clear mui-input" name="mobile" id="mobile" value="" placeholder="手机号码" />
				</div>
				<input type="hidden" name="province" value="111111">
                <input type="hidden" name="city" value="111111">
                <input type="hidden" name="area" value="111111">
                <input type="hidden" name="address" value="默认地址">
                <input type="hidden" name="phone" value="123456">
                <input type="hidden" name="zip" value="000000">
			</div>
		</div>
	</div>
	<h5 class="mui-content-padded">支付方式</h5>
	<div class="mui-card">
		<div class="mui-input-group">
			{set:$paymentList=Api::run('getPaymentList')}
	    	{foreach:items = $paymentList}
	    	{set:$paymentPrice = CountSum::getGoodsPaymentPrice($item['id'],$this->sum);}
			{if:$item['id'] != 10}
			{set:unset($item['config_param'])}
			{set:unset($item['description'])}
				<div class="mui-input-row mui-radio mui-left">
					<label>{$item['name']}</label>
					<input name="payment" type="radio" alt="{$paymentPrice}" value="{$item['id']}" onclick='orderFormInstance.paymentSelected({echo:JSON::encode($item)});' title="{$item['name']}"{if:$item['id'] == 10} checked{/if}>
				</div>
			{/if}
			{if:IClient::isWechat()}
				<div class="mui-input-row mui-radio mui-left">
					<label>微信支付</label>
					<input name="payment" type="radio" value="14" checked>
				</div>
			{/if}
	  	{/foreach}
		</div>
	</div>


	{if:!$this->seller_tutor_id && !$this->user_tutor_id}
	<h5 class="mui-content-padded"></h5>
	<div class="mui-card">
		<div class="mui-input-group">
			<div class="mui-input-row">
				<label>留言</label>
				<input type="text" name="message" value="" placeholder="输入留言" />
			</div>
		</div>
	</div>
	{/if}

	<h5 class="mui-content-padded"></h5>
	<div class="mui-card">
		<ul class="mui-table-view">
			{foreach:items = $this->zuhe_list}
				<li class="mui-table-view-cell mui-media">
					<img class="mui-media-object mui-pull-left" src="{url:/pic/thumb/img/$item[logo]/w/80/h/80}">
					<div class="mui-media-body">
						{$item['name']} - {$item['use_times']}课时
					<div class="qindanjg">价格：<span class="red3">&yen;{$item['max_price']}</span></div>
					<div>人数：<span class="red3">1&nbsp;人</span></div>
					</div>
				</li>
				{/foreach}
		</ul>
	</div>

	<h5 class="mui-content-padded"></h5>
	<div class="mui-card dqk_cart_info">
		<div class="mui-input-group">
			<li class="mui-table-view-cell">
				<div class="mui-media-body"><span class="t-left">原价</span><span class="t-right">{$this->old_price}元</span></div>
			</li>
			<li class="mui-table-view-cell">
				<div class="mui-media-body"><span class="t-left">优惠</span><span class="t-right">省{$this->discount}元</span></div>
			</li>
			<li class="mui-table-view-cell">
				<div class="mui-media-body"><span class="t-left">结算价</span><span class="red2 t-right" id="final_sum">{$this->market_count}元</span></div>
			</li>
		</div>
	</div>
	<div class="mui-content-padded">
		<button type="button" class="mui-btn mui-btn-primary mui-btn-block" id="confirm">确认无误，提交订单</button>
	</div>
</form>

<script type='text/javascript'>
//创建订单表单实例
orderFormInstance = new orderFormClass();
sellerList = {echo:JSON::encode($this->seller)};
ticketList = {echo:JSON::encode($this->prop)};addressList = {if:$this->addressListJson}{$this->addressListJson}{else:}array(){/if};
addressList = {if:$this->addressListJson}{$this->addressListJson}{else:}array(){/if};
sell_count = {if:$this->sell_count}{$this->sell_count}{else:}0.00{/if};
market_count = {if:$this->market_count}{$this->market_count}{else:}0.00{/if};
order_chit = {if:$this->order_chit >0}{$this->order_chit}{else:}0{/if};

{if:$this->statement != 2}
var _max_cprice = {if:$this->max_cprice}{$this->max_cprice}{else:}0{/if};
var _max_order_chit = {if:$this->order_chit >0}{$this->order_chit}{else:}0{/if};
var _cprice = {if:$this->max_cprice}{$this->max_cprice}{else:}0{/if};
var _order_chit = {if:$this->order_chit >0}{$this->order_chit}{else:}0{/if};
var _order_amount = {$this->final_sum};
{/if}

{if:$this->is_show_tutor_detail}
function show_tutor_detail()
{
	if ( $('#tutor_detail_1').get(0).checked)
	{
		$('.list_table').show();
	} else {
		$('.list_table').hide();
	}
}
{/if}

//DOM加载完毕
jQuery(function(){

	{if:$this->statement == 4 && $this->user_tutor_info }
	$('.add_test').click(function(){
		var _html = $('.add_test_html').html();
		$('.test_row').html( $('.test_row').html() + _html );
	});

	$(document).on('click', '.del_test', function(){
		$(this).parent().parent().parent().parent().remove();
		var _num = $('.tutor_num input').val();
		$('.tutor_num input').change();
	});
	{/if}

	orderFormInstance.addressInit("{$this->defaultAddressId}", "{$this->mtruename}", "{$this->mtelephone}");

	//支付方式
	orderFormInstance.paymentInit("{$this->custom['payment']}");

	// 支付方式自动保存
	$('input[name=payment]').click(function(){
		orderFormInstance.paymentSave();
	})

	$('.add_teaching_time').click(function(){
		$('.teaching_time2 ul').append('<li>' + $('.teaching_time2 li').eq(0).html() + '</li>');
	})

	// 地址自动保存
	$('.addr_list input[name=radio_address]').click(function(){
		var _radio_id = $(this).val();
		if ( _radio_id != '' )
		{
			address_save();
		}
	})

	{if:$this->statement == 4 && $this->is_rehired}
	$('.mui-content-ks input').change(function(){

		var re = /^[0-9]+$/;
		var _num = $('.mui-content-ks input').val();
		if ( !re.test(_num) )
		{
			mui.alert('请输入正确的课时', '提示信息');
			$('.mui-content-ks input').val($("input[name=direct_num]").val());
			return false;
		} else {
			{if:$this->seller_tutor_info}
				$.post('/simple/get_tutor_order_count', {seller_tutor_id: {$this->seller_tutor_id}, num: _num}, function(data){
			{elseif:$this->user_tutor_info}
				$.post('/simple/get_tutor_order_count', {user_tutor_id: {$this->user_tutor_id}, num: _num}, function(data){
			{/if}
				//console.log(data);
				if ( data == '0')
				{
					mui.alert('操作失败，该家教信息可能已被删除', '提示信息');
				} else if ( data == '-1') {
					mui.alert('操作失败，参数不正确', '提示信息');
				} else {
					{if:$this->user_tutor_info}
						$('.test_row table').each(function(i){
							var _money = parseFloat($(this).find("input").eq(3).val());
							data = parseFloat(data) + _money;
						})
					{/if}
					console.log(data);
					$('#final_sum').html(data);
					$("input[name=direct_num]").val(_num);
				}
			})
		}
	});
	{/if}

	$('select[name=user_prop_list]').change(function(){
		var prop_count = 0;
		var prop_ids = '';
		if ( $(this).val() != '0')
		{
			//prop_count += parseInt($(this).attr('count'));
			//prop_ids = (prop_ids=='') ? $(this).attr('id') : prop_ids + ',' + $(this).attr('id');
			prop_count += parseInt($('select[name=user_prop_list]').find("option:selected").attr('count'));
			prop_ids = $(this).val();
		}

		$('input[name=user_prop_ids]').val(prop_ids);
		prop_count = parseInt(prop_count);
		if ( prop_count > 0 )
		{
			$('input[name=use_coupon]').val(1);
			$('input[name=coupon_nums]').val(prop_count);
		} else {
			$('input[name=use_coupon]').val(0);
			$('input[name=coupon_nums]').val(0);
		}

		update_use_coupon();
	})

	// 使用学习券的交互
	$('input[name=coupon_nums]').change(function(){
		var _val = $(this).val();
		var _stm = $("input[name=statement]").val();
		if ( _val < 0 )
		{
			alert('券金额不能小于0');
			$(this).val(_max_cprice);
		} else if ( _val % 10 != 0 )
		{
			alert('券必须为10的倍数');
			$(this).val(_max_cprice);
		} else if ( _val > _max_cprice )
		{
			alert('券最多只能使用' + _max_cprice + '元');
			$(this).val(_max_cprice);
		} else {
			//console.log('ajax');
			var _url = '{url:/site/get_order_chit_ajax/cprice/@cprice@/stime/1/statement/@stm@/id/@id@/type/@type@/num/@num@}';
			_url = _url.replace('@cprice@', _val);
			_url = _url.replace('@stm@', _stm );
			_url = _url.replace('@id@', {$this->gid} );
			_url = _url.replace('@type@', '{$this->type}' );
			_url = _url.replace('@num@', '{$this->num}' );
			$.getJSON(_url, function(data){
				if ( data.done )
				{
					$('.prop_value').html(data.retval.chit);
					_order_chit = data.retval.chit;
					update_use_coupon();
				}
			});
		}
	});

	{if:$this->statement == 1 or $this->statement == 3}
	$('input[name=use_coupon]').click(function(){
		update_use_coupon();
	});

	function update_use_coupon()
	{
		if ( $('input[name=use_coupon]').val() == '1' )
		{
			var _coupon_nums = $("input[name=coupon_nums]").val();
			$('input[name=coupon_nums]').removeAttr('disabled');
			$('.dai_nums').html(_coupon_nums );
		} else {
			$('.dai_nums').html('0');
			$('input[name=coupon_nums]').attr('disabled', 'disabled');
		}

		caculate();
	}
	{/if}

	function caculate()
	{
		var _coupon_nums = $("input[name=coupon_nums]").val();
		if ( $('input[name=use_coupon]').val() == '1' )
		{
			var _sum = market_count - _coupon_nums;
			var _t_yh = _order_chit - parseFloat($("input[name=coupon_nums]").val());
			$('.yh').html( _t_yh );
		} else {
			var _sum = market_count;
		}

		$('.yf_count').html(_sum);
	}

	document.getElementById('confirm').addEventListener('tap', function(){
		submitForm();
	});

	document.getElementById('add').addEventListener('tap', function(){
		var num = document.getElementById('num').value;
		document.getElementById('direct_num').value = num;
	});

	document.getElementById('minus').addEventListener('tap', function(){
		var num = document.getElementById('num').value;
		document.getElementById('direct_num').value = num;
	});
});

//[address]保存到常用的地址
function address_save()
{
	if(orderFormInstance.addressCheck())
	{
		if ( addressList.length > 0 )
		{
			var _accept_name = $('input[name=accept_name]').val();
			var _mobile = $('input[name=mobile]').val();
			if ( _accept_name == '' || _mobile == '')
			{
				mui.toast('姓名或联系方式不能为空');
				return false;
			}
			for( var i = 0; i < addressList.length; i++)
			{
				if ( addressList[i]['accept_name'] == _accept_name && addressList[i]['mobile'] == _mobile )
				{
					$('.addr_list').find("input[type=radio]").eq(i).attr("checked","checked");
					orderFormInstance.addressSave();
					$('#order_form').submit();
					return;
				}
			}
		}
		$.getJSON('{url:/simple/address_add}',$('form[name="order_form"]').serialize(),function(content){
			if(content.data)
			{
				//$('input:radio[name="radio_address"]:first').trigger('click');
				$('#order_form').submit();
				return;
			}
			//orderFormInstance.addressSave();
		});
		var _address_info = [];
		var _accept_name = $('input[name=accept_name]').val();
		var _mobile = $('input[name=mobile]').val();
		_address_info['accept_name'] = _accept_name;
		_address_info['mobile'] = _mobile;
		addressList.push(_address_info);
	}
}

function submitForm(){
	var accept_name = document.getElementById('accept_name').value,
		mobile = document.getElementById('mobile').value;
	{if:$this->statement == 4 && $this->is_rehired}
		var re = /^[0-9]+$/ ;
		var _num = $('.mui-content-ks input').val();
		if ( !re.test(_num) )
		{
			mui.alert('请输入正确的课时', '提示信息');
			$('.mui-content-ks input').val('1');
			return false;
		}
		var _val = $('.teaching_time2 li').eq(0).find("input").val();
		if ( _val == '')
		{
			mui.alert('请选择上课时间', '提示信息');
			return false;
		}
	{/if}
	if(accept_name == ''){
		mui.alert('请填写联系人', '提示信息');
		return false;
	}
	if(mobile == ''){
		mui.alert('请填写手机号码', '提示信息');
		return false;
	}
	if($('input:radio[name="payment"]:checked').length <= 0 )
	{
		mui.alert('请选择支付方式', '提示信息');
		return false;
	}

	{if:$this->is_show_tutor_detail}
	if ( $('#tutor_detail_1').get(0).checked)
	{
		if ( $('input[name=lowest_reward]').val() == '')
		{
			mui.alert('请输入最低支付的报酬', '提示信息');
			return false;
		}
	}
	{/if}
	address_save();
	//$('#order_form').submit();
}
</script>
