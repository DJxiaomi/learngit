{set:$orderStatus = Order_class::getOrderStatus(array('order_no' => $order_no,'status' => $status,'pay_type' => $pay_type,'distribution_status' => $distribution_status))}
{set:$orderInstance = new Order_Class();$orderRow = $orderInstance->getOrderShow($id)}
{set:$is_order_refund = Refundment_doc_class::is_order_refund( $orderRow['id']);}
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"/>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<div class="headbar clearfix">
	<ul class="tab" name="menu1">
		<li id="li_1"><a href="javascript:selectTab('1');" hidefocus="true">基本信息</a></li>
		<li id="li_2"><a href="javascript:selectTab('2');" hidefocus="true">收退款</a></li>
		<li id="li_4"><a href="javascript:selectTab('4');" hidefocus="true">备注</a></li>
		<li id="li_6"><a href="javascript:selectTab('6');" hidefocus="true">附言</a></li>
	</ul>
</div>

<div id="tab-1" name="table" style="display:none">
	<div class="content">
		<table class="list_table">
			<colgroup>
				<col />
				<col width="90px" />
				<col width="150px" style="display: none;" />
			</colgroup>

			<thead>
				<tr>
					<th>课程</th>
					<th>课程原价</th>
					<th>实际价格</th>
					<th>课程数量</th>
					<th style="display: none;">是否验证</th>
				</tr>
			</thead>
			<tbody>
				{query:name=order_goods where=order_id eq $order_id}
				<tr>
					<td>
						{set:$goodsRow = JSON::decode($item['goods_array'])}
						<a href="{url:/site/products/id/$item['goods_id']}" target="_blank">{$goodsRow['name']} &nbsp;&nbsp; {$goodsRow['value']}</a>
					</td>
					<td>￥{$item['goods_price']}</td>
					<td>￥{$item['real_price']}</td>
					<td>{$item['goods_nums']}</td>
					<td style="display: none;">
						{echo:Order_Class::goodsSendStatus($item['is_send'])}
						{if:$item['delivery_id'] && 1 == 0 }
						<button class="btn" onclick="freightLine({$item['delivery_id']})">快递跟踪</button>
						{/if}
						{if:order_class::getOrderStatus( $orderRow ) == 4}
							{if: $item['verification_code'] != ''}
								<input type="button" class="alt_btn" onclick="deliver_with_verifi('{$item['order_id']}', '{$item['goods_id']}')" value="点击发货" style="cursor: pointer;" />
							{else:}
								<input type="button" class="alt_btn" onclick="delivers('{$item['order_id']}', '{$item['goods_id']}')" value="点击发货" style="cursor: pointer;" />
							{/if}
						{/if}
					</td>
				</tr>
				{/query}
			</tbody>
		</table>

		<table style="width:300px;margin-right:20px;" class="border_table f_l">
			<col width="80px" />
			<col />
			<thead>
				<tr><th colspan="2">订单信息</th></tr>
			</thead>
			<tbody>
				<tr>
					<th>订单号:</th><td>{$order_no}</td>
				</tr>
				<tr>
					<th>下单时间:</th><td>{$orderRow['create_time']}</td>
				</tr>
				<tr>
					<th>结算方式:</th><td>{if:$orderRow['statement'] == 1}全款{elseif:$orderRow['statement'] == 2}代金券{else:}定金{/if}</td>
				</tr>
				<tr>
					<th>{if:$orderRow['statement'] == 1}全款{elseif:$orderRow['statement'] == 2}代金券{else:}定金{/if}:</th><td>￥{$order_amount}</td>
				</tr>
				{if:$orderRow['statement'] == 2}
				<tr>
					<th>抵用:</th><td>￥{$orderRow['chit']}</td>
				</tr>
				<tr>
					<th>尾款:</th><td>￥{$orderRow['rest_price']}</td>
				</tr>
				{elseif:$orderRow['statement'] == 3}
				<tr>
					<th>尾款:</th><td>￥{$orderRow['rest_price']}</td>
				</tr>
				{/if}
				<tr>
					<th>支付方式:</th><td>{$orderRow['payment']}</td>
				</tr>
				<tr>
					<th>订单状态:</th><td>{echo:order_class::orderStatusText(order_class::getOrderStatus($orderRow),3, $orderRow['statement'])}</td>
				</tr>
			</tbody>
		</table>

		<table style="width:300px;margin-right:20px;" class="border_table f_l">
			<col width="80px" />
			<col />
			<thead>
				<tr><th colspan="2">学员信息</th></tr>
			</thead>
			<tbody>
				<tr>
					<th>姓名:</th><td>{$accept_name}</td>
				</tr>
				<tr>
					<th>手机 :</th><td>{$mobile}</td>
				</tr>
				<tr>
					<th>用户名:</th><td>{$username}</td>
				</tr>
			</tbody>
		</table>

	</div>
</div>

<div id="tab-2" name="table" style="display:none">
	<div class="content">
		<table style="width:45%;margin-right:20px;" class="border_table f_l">
			<colgroup>
				<col width="120px" />
				<col />
			</colgroup>

			<thead>
				<tr><th colspan="2">收款单据</th></tr>
			</thead>

			<tbody>
				{query: name=collection_doc as c join=left join payment as p on c.payment_id eq p.id where=c.order_id eq $order_id items=$collectionData fields=c.*,p.name}
				<tr>
					<th>付款时间：</th><td>{$item['time']}</td>
				</tr>
				<tr>
					<th>金额：</th><td>{$item['amount']}</td>
				</tr>
				<tr>
					<th>支付方式：</th><td>{$item['name']}</td>
				</tr>
				<tr>
					<th>付款备注：</th><td>{$item['note']}</td>
				</tr>
				<tr>
					<th>状态：</th><td>{if:$item['pay_status']==0}准备中{else:}支付完成{/if}</td>
				</tr>
				<tr><th colspan="2"></th></tr>
				{/query}
			</tbody>
		</table>

		<table style="width:45%;margin-right:20px;" class="border_table f_l">
			<colgroup>
				<col width="120px" />
				<col />
			</colgroup>

			<thead>
				<tr><th colspan="2">退款单据</th></tr>
			</thead>
			<tbody>
				{query: name=refundment_doc where=order_id eq $order_id items=$refundmentData}
				<tr>
					<th>课程退款：</th>
					<td>
						{query:name=order_goods where=id in ($item[order_goods_id]) item=$orderGoods}
						{set:$goods = JSON::decode($orderGoods['goods_array'])}
						<p>
						<a href="{url:/site/products/id/$orderGoods['goods_id']}" target="_blank" title="{$goods['name']}">{echo:IString::substr($goods['name'],28)} X {$orderGoods['goods_nums']}</a>
						{if:$item['seller_id']}
						<a href="{url:/site/home/id/$item['seller_id']}" target="_blank"><img src="{skin:images/admin/seller_ico.png}" /></a>
						{/if}
						</p>
						{/query}
					</td>
				</tr>
				<tr>
					<th>退款金额：</th><td>{$item['amount']}</td>
				</tr>
				<tr>
					<th>申请时间：</th><td>{$item['time']}</td>
				</tr>
				<tr>
					<th>状态：</th><td>{echo:Order_Class::refundmentText($item['pay_status'])}</td>
				</tr>
				<tr>
					<th>退款理由：</th><td>{$item['content']}</td>
				</tr>
				<tr><th colspan="2"></th></tr>
				{/query}
			</tbody>
		</table>
	</div>
</div>

<div id="tab-3" name="table" style="display:none">
	<div class="content">
		<table style="width:98%" class="border_table">
			<colgroup>
				<col width="150px" />
				<col width="120px" />
				<col width="120px" />
				<col width="150px" />
				<col width="150px" />
				<col />
			</colgroup>

			<thead>
				<tr>
					<th>配送时间</th>
					<th>配送方式</th>
					<th>物流公司</th>
					<th>物流单号</th>
					<th>收件人</th>
					<th>备注</th>
				</tr>
			</thead>

			<tbody>
				{query: name=delivery_doc as c join=left join delivery as p on c.delivery_type eq p.id fields=c.*,p.name as pname where=c.order_id eq $order_id items=$deliveryData}
				<tr>
					<td>{$item['time']}</td>
					<td>{$item['pname']}</td>
					<td>{query:name=freight_company where=id eq $item[freight_id] item=$tempFreight}{$tempFreight['freight_name']}{/query}</td>
					<td>{$item['delivery_code']}</td>
					<td>{$item['name']}</td>
					<td>{$item['note']}</td>
				</tr>
				{/query}
			</tbody>
		</table>
	</div>
</div>

<div id="tab-4" name="table" style="display:none">
	<div class="content">
		<div class="content form_content">
		<form name="ModelForm" action="{url:/order/order_note}" method="post">
			<input type="hidden" name="order_id" value="{$order_id}"/>
			<input type="hidden" name="tab" value="6"/>
			<table class="form_table">
				<col width="150px" />
				<col />
				<tbody>
					<tr>
						<th>订单备注:</th>
						<td align="left"><textarea name="note" id="note" rows="8" cols="100">{$note}</textarea></td>
					</tr>
					<tr>
						<td></td>
						<td align="left"><button type="submit" class="submit"><span>保存</span></button></td>
					</tr>
				</tbody>
			</table>
		</form>
		</div>
	</div>
</div>

<div id="tab-5" name="table" style="display:none">
	<div class="content">
		<table class="border_table" style='width:98%'>
			<colgroup>
				<col width="200px">
				<col width="150px">
				<col width="150px">
				<col width="100px">
				<col />
			</colgroup>
			<thead>
				<tr>
					<th>时间</th>
					<th>操作人</th>
					<th>动作</th>
					<th>结果</th>
					<th>备注</th>
				</tr>
			</thead>
			<tbody>
				{query: name=order_log as ol where=ol.order_id eq $order_id}
				<tr>
					<td>{$item['addtime']}</td>
					<td>{$item['user']}</td>
					<td>{$item['action']}</td>
					<td>{$item['result']}</td>
					<td>{$item['note']}</td>
				</tr>
				{/query}
			</tbody>
		</table>
	</div>
</div>

<div id="tab-6" name="table" style="display:none">
	<div class="content">
		<div class="content form_content">
			<table class="form_table">
				<col width="150px" />
				<col />
				<tbody>
					<tr>
						<th>订单附言:</th>
						<td align="left">{$postscript}</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
</div>

<div class="pages_bar">
	<div class="t_c" id="ctrlButtonArea">
		<button type="button" class="submit" id="to_pay" onclick="pay({$order_id});"><span>支付</span></button>
		<button type="button" class="submit" id="to_confirm" onclick="confirm({$order_id});"><span>确认付款</span></button>
		<button type="button" class="submit" id="to_deliver" onclick="deliver({$order_id});" style="display: none;"><span>发货</span></button>
		<button type="button" class="submit" id="to_refundment" onclick="refundment({$order_id});"><span>退款</span></button>
		<button type="button" class="submit" id="to_finish" onclick="complete({$order_id},5)"><span>完成</span></button>
		<button type="button" class="submit" id="to_cancel" onclick="complete({$order_id},4)"><span>作废</span></button>
	</div>
</div>

<script type='text/javascript'>
//DOM加载完毕后运行
$(function()
{
	selectTab(1);
	initButton();
});

// 验证码发货
function deliver_with_verifi( _order_id, _goods_id )
{
	art.dialog("请输入该课程的验证码：<input type='text' class='normal small' name='verification_code' id='verification_code' value='' style='height: 25px; line-height: 25px;' />&nbsp; &nbsp; <input type='button' id='deliver' value='发货' style='background-color:#ff5500; color: #fff;text-shadow: 0;width: 50px; border: 0px;height: 25px; line-height: 25px;cursor: pointer;border-radius: 3px;'/>");
	$('#deliver').click(function(){
		var _verification_code = $('#verification_code').val();
		if ( _verification_code == "")
		{
			alert("请输入验证码");
		} else {
			var _tempUrl = "/order/order_delivery_doc_ajax/id/" + _order_id + '/sendgoods/' + _goods_id + '/verification_code/' + _verification_code;
			$.get( _tempUrl, function(data){
				if ( data == '1')
					window.location.reload();
				else
					alert( data );
			})
		}
	})
}

// 普通发货
function delivers( _order_id, _goods_id )
{
	art.dialog({
		content: '您确认要使用此课程吗？',
		ok:function() {
			var _tempUrl = "/order/order_delivery_doc_ajax/id/" + _order_id + '/sendgoods/' + _goods_id;
			$.get( _tempUrl, function(data){
				if ( data == '1')
					window.location.reload();
				else
					alert( data );
			})
		},
		cancelVal:'取消',
		cancel: true,
	})
}

// 确认订单
function confirm( _order_id )
{
	art.dialog({
		content: '您确定要确认付款吗？',
		ok:function() {
			var _tempUrl = "/order/order_confirm_ajax/id/" + _order_id;
			$.get( _tempUrl, function(data){
				if ( data == '1')
					window.location.reload();
				else {
					if ( data == '-1')
						alert('该订单不存在');
					else
						alert('操作失败');
				}
			})
		},
		cancelVal:'取消',
		cancel: true,
	})
}

/**
 * 订单操作按钮初始化
 */
function initButton()
{
	//全部操作区域的按钮锁定
	$('#ctrlButtonArea button').attr('disabled','disabled');
	$('#ctrlButtonArea button').addClass('inactive');

	//作废
	//$('#to_cancel').removeAttr('disabled');
	//$('#to_cancel').removeClass('inactive');

	//完成
	{if:in_array($orderStatus,array(11,3)) || order_class::getOrderStatus( $orderRow ) == 4}
	$('#to_finish').removeAttr('disabled');
	$('#to_finish').removeClass('inactive');
	{/if}

	//付款
	{if:in_array($orderStatus,array(11,2))}
	$('#to_pay').removeAttr('disabled');
	$('#to_pay').removeClass('inactive');
	{/if}

	//发货
	{if:in_array($orderStatus,array(1,4,8,9))}
	$('#to_deliver').removeAttr('disabled');
	$('#to_deliver').removeClass('inactive');
	{/if}

	//退款
	{if:Order_Class::isRefundmentApply($orderRow)}
	$('#to_refundment').removeAttr('disabled');
	$('#to_refundment').removeClass('inactive');
	{/if}

	// 确认订单
	{if:order_class::getOrderStatus( $orderRow ) == 13}
	$('#to_confirm').removeAttr('disabled');
	$('#to_confirm').removeClass('inactive');
	{/if}
}

//选择当前Tab
function selectTab(curr_tab)
{
	$("div[name='table']").hide();
	$("#tab-"+curr_tab).show();
	$("ul[name=menu1] > li").removeClass('selected');
	$('#li_'+curr_tab).addClass('selected');
}

//完成或作废订单
function complete(id,statusVal)
{
	$.get("{url:/order/order_complete}",{'order_no':"{$order_no}",'type':statusVal,'id':id}, function(data)
	{
		if(data=='success')
		{
			actionCallback();
		}
		else
		{
			alert('发生错误');
		}
	});
}

//退款
function refundment(id)
{
	{if:$statement == 2}
	var _title = '订单号:{$order_no}【退还代金券到账户】';
	{else:}
	var _title = '订单号:{$order_no}【退款到余额账户】';
	{/if}
	var tempUrl = '{url:/order/order_refundment/id/@id@}';
	tempUrl     = tempUrl.replace('@id@',id);
	art.dialog.open(tempUrl,{
		id:'refundment',
		cancelVal:'关闭',
		okVal:'退款',
	    title: _title,
	    ok:function(iframeWin, topWin){
	    	iframeWin.document.forms[0].submit();
	    	return false;
	    },
	    cancel:function(){
	    	return true;
		}
	});
}

//付款
function pay(id)
{
	var tempUrl = '{url:/order/order_collection/id/@id@}';
	tempUrl     = tempUrl.replace('@id@',id);

	art.dialog.open(tempUrl,{
		id:'pay',
	    title: '订单号:{$order_no}【付款】',
	    cancelVal:'关闭',
		okVal:'付款',
	    ok:function(iframeWin, topWin){
			iframeWin.document.forms[0].submit();
			return false;
	    },
	    cancel:function (){
	    	return true;
		}
	});
}

//发货
function deliver(id)
{
	var tempUrl = '{url:/order/order_deliver/id/@id@}';
	tempUrl     = tempUrl.replace('@id@',id);

	var deliv = art.dialog.open(tempUrl,{
		id:'deliver',
	    title: '订单号:{$order_no}【发货】',
	    cancelVal:'关闭',
		okVal:'发货',
	    ok:function(iframeWin, topWin){
	    	var checkedNums = $(iframeWin.document).find('[name="sendgoods[]"]:checked').length;
	    	if(checkedNums == 0)
	    	{
	    		alert('请选择要发货的课程');
	    		return false;
	    	}
	    	var isResult = iframeWin.document.forms[0].onsubmit();
	    	if(isResult != false)
	    	{
	    		iframeWin.document.forms[0].submit();
	    	}
	    	return false;
	    },
	    cancel:function (){
	    	return true;
		}
	});
}

//执行回调处理
function actionCallback(msg)
{
	msg ? alert(msg) : window.location.reload();
	window.setTimeout(function()
	{
		var list = art.dialog.list;
		for (var i in list)
		{
		    list[i].close();
		};
	},2500);
}

//操作失败回调
function actionFailCallback(msg)
{
	var alertText = msg ? msg : '操作失败';
	alert(alertText);
}

//快递跟踪
function freightLine(doc_id)
{
	var urlVal = "{url:/block/freight/id/@id@}";
	urlVal = urlVal.replace("@id@",doc_id);
	art.dialog.open(urlVal,{title:'轨迹查询'});
}
</script>
