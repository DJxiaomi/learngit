<?php $this->title = '找回密码'; ?>
<!doctype html>
<html>
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=Edge">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>{$this->_siteConfig->name}</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
	<link type="image/x-icon" href="{webroot:favicon.ico}" rel="icon">
	<link href="{rs:/css/font-awesome.min.css}" rel="stylesheet" type="text/css" />
	<link href="{theme:javascript/mui/css/mui.min.css}" rel="stylesheet" type="text/css" />
	<link href="{skin:css/common.css}" rel="stylesheet" type="text/css" />
	<script type="text/javascript" src="{rs:/scripts/jquery-3.1.1.min.js}"></script>
	<script type="text/javascript" src="{theme:javascript/mui/js/mui.min.js}"></script>
	<script type="text/javascript" src="{rs:/scripts/common.js}"></script>
	<script type="text/javascript">mui.init({swipeBack:true});var SITE_URL = '';</script>
	<style>
	.mui-btn-primary {background:linear-gradient(to right,#ff9638,#ff4b2b);border:0px;}
	</style>
</head>
<body>
	<header class="mui-bar mui-bar-nav">
	    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
	    {if:$isctrl}
	    <a href="{url:$isctrl['url']}" class="mui-btn mui-btn-white mui-btn-link mui-pull-right">{$isctrl['text']}</a>
	    {/if}
	    <h1 class="mui-title">{echo:mb_substr($this->title,0,16,'utf-8');}</h1>
	</header>
	<div class="mui-content">

  <link rel="stylesheet" type="text/css" href="/views/mobile/skin/blue/css/simple.css" />
  <form id='login-form' class="mui-input-group">
      <div class="mui-input-row">
          <label>账号</label>
          <input type="text" class="mui-input-clear mui-input" name="username" id="username" placeholder="用户名/手机号/邮箱">
      </div>
      <div class="mui-input-row">
          <label>手机号</label>
          <input type="text" class="mui-input" name="mobile" id="mobile" placeholder="请输入手机号">
          <a href="javascript:;" id="sendcode" class="sendcode">发送验证码</a>
      </div>
      <div class="mui-input-row">
          <label>手机验证码</label>
          <input type="text" class="mui-input-clear mui-input" name="mobile_code" id="mobile_code" placeholder="请输入手机验证码">
      </div>
  </form>
  <div class="mui-content-padded">
      <button id='find' class="mui-btn mui-btn-block mui-btn-primary">提交</button>
      </div>
  </div>

</body>
</html>

  <script language="javascript">
  var default_time = 60;
  var s_count = 60;
  var send_status = true;
  document.getElementById('sendcode').addEventListener('tap', function(){
      var mobile = document.getElementById('mobile').value;
      var username = document.getElementById('username').value;
      if ( s_count == default_time && send_status ){
          mui.get('{url:/simple/send_message_mobile}', {"username":username,"mobile":mobile,"type":"business"}, function(res){
              if(res == 'success'){
                  updateState();
                  timer = setInterval(function(){
                      updateState();
                  }, 1000);
              }else{
                  mui.toast(res);
              }
          });
      }
  });

  function updateState(){
      if ( s_count > 0 ){
          s_count--;
          send_status = false;
          document.getElementById('sendcode').innerText = s_count + ' s后重新发送';
      } else {
          s_count = default_time;
          send_status = true;
          clearInterval(timer);
          document.getElementById('sendcode').innerText = '重新发送验证码';
      }
  }

  document.getElementById('find').addEventListener('tap', function(){
      var username = document.getElementById('username').value,
          mobile = document.getElementById('mobile').value,
          mobile_code = document.getElementById('mobile_code').value;
      if(username == ''){
          mui.toast('请输入用户名');
          return false;
      }
      if(mobile == ''){
          mui.toast('请输入密码');
          return false;
      }
      if(mobile_code == ''){
          mui.toast('请输入手机验证码');
          return false;
      }
      mui.post('{url:/simple/find_password_mobile_ajax}', {username: username, mobile: mobile, mobile_code: mobile_code, type: 1}, function(json){
          if(json.status == '1'){
              window.location.href = SITE_URL + json.str;
          }else{
              mui.toast(json.str);
          }
      }, 'json');
  });
  </script>
