<link href="{theme:javascript/mui/css/mui.picker.css}" rel="stylesheet" type="text/css" />
<link href="{theme:javascript/mui/css/mui.poppicker.css}" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="/plugins/newupload/plupload.full.min.js"></script>
<h5 class="mui-content-padded">资料修改</h5>
<div class="mui-content-padded" style="margin:0;">
	<form class="mui-input-group" action="{url:/seller/brand_add}" method="post" enctype='multipart/form-data' id="brandFrom">
		<div class="mui-input-row">
			<label>用户名</label>
			{$this->brandRow['username']}
		</div>
		<div class="mui-input-row">
			<label>注册名称</label>
			{$this->brandRow['name']}
		</div>
		<div class="mui-input-row">
			<label>学校简称</label>
			<input type="text" name="shortname" value="{$this->brandRow['shortname']}" placeholder="请填写学校简称" />
		</div>
		<p>logo</p>
		<div id="image-list" class="row image-list">
			{if:$this->brandRow['logo']}
			<div class="image-item space" id="prev" style="background:url({webroot:$this->brandRow['logo']}) no-repeat center center;background-size:100% 100%;"><div class="image-close" onclick="deloneimage(this)">删除</div></div>
			{/if}
			<div class="image-item space" id="uppic"><input type="file" accept="image/*" id="image-1"></div>
			<input type="hidden" name="logo" id="logo" value="{$this->brandRow['logo']}">
		</div>
		<div class="mui-input-row" id="categorytxt">
			<label>所属分类</label>
			<span>{if:$brand_info['catname']}{$brand_info['catname']}{else:}请选择{/if}</span>
			<input type="hidden" name="category" id="category" />
			<i class="icon-angle-right"></i>
		</div>
		<p>轮播图</p>
		<div id="adimage-list" class="row image-list">
			{foreach:$items=$brand_info['ad_arr']}
			<div class="image-item item-list space" src="{webroot:$item}" data-preview-src="" data-preview-group="1" style="background:url({webroot:$item}) no-repeat center center;background-size:100% 25%;"><div class="image-close" onclick="delimage(this, '{$item}')">删除</div></div>
			{/foreach}
			<div class="image-item space" id="uploadButton"></div>
		</div>
		<script type="text/javascript">
		var uploader = new plupload.Uploader({
            runtimes: 'html5,flash,silverlight,html4',
            browse_button: 'uploadButton',
            url: "{url:/seller/goods_img_upload}",
            filters: {
                max_file_size: '2048kb',
                mime_types: [
                    {title: "files", extensions: "jpg,png,gif,JPG,JPEG"}
                ]
            },
            multi_selection: true,
            init: {
                FilesAdded: function(up, files) {
                    uploader.start();
                },
                UploadProgress: function(up, file) {
                	Lx.common.loading();
                },
                FileUploaded: function(up, file, info) {
                   	var data = eval("(" + info.response + ")");
                    uploadPicCallback(data);

                },
                Error: function(up, err) {
                    mui.toast(err.message);
                }
            }
        });

        uploader.init();


        function uploadPicCallback(picJson)

		{
			if ( picJson.flag == -10 )
			{
				mui.toast('上传失败,请上传{$default_goods_photo_width}x{$default_goods_photo_height}像素的图片');
				return false;
			}
			$('#adimage-list').prepend('<div class="image-item item-list space" src="/' + picJson.img + '" style="background:url(/' + picJson.img + ') no-repeat center center;background-size:100% 25%;"></div><span class="imgListprocess" style="display:none;">' + picJson.img + '</span>');
			Lx.common.loadingClose();
			prevImg();
		}

		function delimage(obj, ad){
			$(obj).parent().remove();
			var adimg = $('#adimg').val();
			var adArr = adimg.split(',');
			if(adArr.length == 1){
				$('#adimg').val('');
			}else{
				$('#adimg').val(adimg.replace(',' + ad, ''));
			}

			$.post('{url:/brand/ad_del}', {ad: ad, brand_id: '{$this->brandRow['id']}'}, function(json){
				if(json.msg == 1){
				}else{
					mui.toast('删除失败');
				}
			}, 'json');
		}

		function deloneimage(obj){
			$(obj).parent().remove();
			$('#logo').val('');
		}
        </script>
		<p>学校简介</p>
		<textarea name="description" id="description" class="txt" placeholder="请填写学校简介">{$brand_info['description']}</textarea>
		<div class="mui-input-row">
			<label>固定电话</label>
			<input type="text" name="telephone" value="{$this->brandRow['telephone']}" placeholder="请填写固定电话" />
		</div>
		<div class="mui-input-row" id="region">
			<label>学校地址</label>
			<span id="province">{if:$brand_info['provinceval']}{$brand_info['provinceval']}{else:}湖南省{/if}</span>
			<span id="city">{if:$brand_info['cityval']}{$brand_info['cityval']}{else:}株洲市{/if}</span>
			<span id="discrict">{if:$brand_info['discrictval']}{$brand_info['discrictval']}{else:}市辖区{/if}</span>
			<input type="hidden" name="province" id="provinceval" value="{if:$this->brandRow['province']}{$this->brandRow['province']}{else:}430000{/if}" />
			<input type="hidden" name="city" id="cityval" value="{if:$this->brandRow['city']}{$this->brandRow['city']}{else:}430200{/if}" />
			<input type="hidden" name="area" id="discrictval" value="{if:$this->brandRow['discrict']}{$this->brandRow['discrict']}{else:}430201{/if}" />
			<i class="icon-angle-right"></i>
		</div>
		<div class="mui-input-row">
			<label>详细地址</label>
			<input type="text" name="address" value="{$this->brandRow['address']}" placeholder="请填写详细地址" />
		</div>
		<div class="mui-input-row">
			<label>邮箱</label>
			<input type="text" name="email" value="{$this->brandRow['email']}" placeholder="请填写邮箱" />
		</div>
		<div class="mui-input-row">
			<label>QQ</label>
			<input type="text" name="server_num" value="{$this->brandRow['qq']}" placeholder="请填写QQ" />
		</div>
		<div class="mui-input-row">
			<label>登录密码</label>
			<input type="password" name="password" placeholder="需要修改时填写密码" />
		</div>
		<div class="mui-input-row">
			<label>自定义网址</label>
			<input type="text" name="url" value="{$this->brandRow['url']}" placeholder="自定义网址" />
		</div>
		<p style="display:none;">基本信息</p>
		<div id="infomation" style="display:none;">
			{if:$brand['attrs']}
			{foreach:$items = $brand['attrs']}
			<div class="mui-card">
				<div class="mui-card-content">
					<div class="mui-input-row">
						<label>栏目名称 <a href="javascript:;" onclick="addPic('{$key}')">增加</a></label>
						<input name="navtitle[]" type="text" placeholder="栏目标题：例如学校信息、老师信息" value="{$item['navtitle']}" />
					</div>
					{foreach:$items = $item['info'] key=$idx item=$val}
					<div id="soninfo{$key}">
						<div class="mui-card">
							<div class="mui-card-content">
								<div class="mui-input-row">
									<label>上传图片</label>
									<input type='file' class='normal' name='img[{$key}][]'/>
									<input type="hidden" name="oldimg[{$key}][]" value="{$val['img']}">
								</div>
								<div class="mui-input-row">
									<label>图片标题</label>
									<input type="text" name="imgtitle[{$key}][]" placeholder="图片标题" maxlength="40" value="{$val['imgtitle']}" />
								</div>
								<div class="mui-input-row">
									<label>图片描述</label>
									<input type="text" name="imgbrief[{$key}][]" placeholder="图片描述" maxlength="40" value="{$val['imgbrief']}" />
								</div>
							</div>
							<div class="mui-card-footer">
								<a class="mui-card-link" onclick="del(this);">删除信息</a>
							</div>
						</div>
					</div>
					{/foreach}
				</div>
				<div class="mui-card-footer">
					<a class="mui-card-link" onclick="del(this);">删除栏目</a>
				</div>
			</div>
			{/foreach}
			{else:}
			<div class="mui-card">
				<div class="mui-card-content">
					<div class="mui-input-row">
						<label>栏目名称 <a href="javascript:;" onclick="addPic(0)">增加</a></label>
						<input name="navtitle[]" type="text" placeholder="栏目标题：例如学校信息、老师信息" />
					</div>
					<div id="soninfo0">
						<div class="mui-card">
							<div class="mui-card-content">
								<div class="mui-input-row">
									<label>上传图片</label>
									<input type='file' name="img[0][]"/>
								</div>
								<div class="mui-input-row">
									<label>图片标题</label>
									<input type="text" name="imgtitle[0][]" placeholder="图片标题" maxlength="40" />
								</div>
								<div class="mui-input-row">
									<label>图片描述</label>
									<input type="text" name="imgbrief[0][]" placeholder="图片描述" maxlength="40" />
								</div>
							</div>
							<div class="mui-card-footer">
								<a class="mui-card-link" onclick="del(this);">删除信息</a>
							</div>
						</div>
					</div>
				</div>
				<div class="mui-card-footer">
					<a class="mui-card-link" onclick="del(this);">删除栏目</a>
				</div>
			</div>
			{/if}
		</div>
		<div class="mui-button-row">
			<input type="hidden" name="brand_id" value="{$this->brandRow['id']}">
			<input type="hidden" name="img" id="img" value="{$brand_info['img']}" />
			<input type="hidden" name="adimg" id="adimg" value="{$brand_info['adimg']}" />
			<button type="button" class="mui-btn mui-btn-primary" onclick="setAdImg()">确认</button>&nbsp;&nbsp;
			<button type="button" class="mui-btn mui-btn-danger" onclick="addInfomation()" style="display:none;">增加栏目</button>
		</div>
	</form>
</div>
<!-- 弹出菜单 -->

<script type='text/html' id='picTemplate2'>
 <div class='pic'>
		 <div class='pic_image'><img width="150" src="<?php echo IUrl::creatUrl("")."<%=picRoot%>";?>" alt="<%=picRoot%>" /></div>
		 <div class='pic_dels'><a href='javascript:void(0)'>删除</a></div>
 </div>
 </script>
<script type="text/javascript" src="{theme:javascript/mui/js/mui.picker.js}"></script>
<script type="text/javascript" src="{theme:javascript/mui/js/mui.poppicker.js}"></script>
<script type="text/javascript">
mui.init();
mui.ready(function(){
	var catdata = "[{vaue: '', text: '请选择'}";
	{query:name=brand_category}{/query}
	{if:$items}
	{foreach:items=$items}
	catdata += ",{value: '{$item['id']}', text: '{$item['name']}'}";
	{/foreach}
	{else:}
	catdata += "{value: '', text: '无系统分类'}";
	{/if}
	catdata += ']';
	var userPicker = new mui.PopPicker();
	userPicker.setData(eval('(' + catdata + ')'));
	var showUserPickerButton = document.getElementById('categorytxt');
	showUserPickerButton.addEventListener('tap', function(event) {
		userPicker.show(function(items) {
			$('#category').val(items[0].value);
			$('#categorytxt').find('span').text(items[0].text);
		});
	}, false);

	var regionPicker = new mui.PopPicker({
		layer: 3
	});
	regionPicker.setData({$regiondata});
	regionPicker.pickers[0].setSelectedValue(430000, 0);
	regionPicker.pickers[1].setSelectedValue(430200, 1);
	var PickerButton = document.getElementById('region');
	PickerButton.addEventListener('tap', function(event) {
		regionPicker.show(function(items) {
			$('#provinceval').val(items[0].value);
			$('#province').text(items[0].text);
			$('#cityval').val(items[1].value);
			$('#city').text(items[1].text);
			$('#discrictval').val(items[2].value);
			$('#discrict').text(items[2].text);
		});
	}, false);

	prevImg();
});
$.jUploader({
    button: 'uppic',
    action: '{url:/seller/pic_upload}',
    allowedExtensions: ['jpg', 'png', 'gif', 'jpeg', 'JPG', 'JPEG'],
    onUpload: function(fileName){
    	Lx.common.loading();
    },
    onComplete: function(fileName, response){
      	if(response.success){
      		$('#logo').val(response.fileurl);
      		$('.image-item-loading').remove();
      		if($('#prev').length == 1){
      			$('#prev').css('background-image', 'url(/' + response.fileurl + ')');
      		}else{
      			$('#image-list').prepend('<div class="image-item space" id="prev" style="background:url(/' + response.fileurl + ') no-repeat center center;background-size:100% 100%;"></div>');
      		}
      	}else{
        	mui.toast('上传失败');
      	}
      	Lx.common.loadingClose();
    }
});

function prevImg(){

	mui('body').on('tap', '.item-list', function(){
		var img = this.getAttribute('src');
		var divbox = '<div class="prev-box" style="background-image:url(' + img + ')"></div>', divboxbg = '<div class="prev-box-bg"></div>';
		$('body').append(divboxbg);
		$('body').append(divbox);

		mui('body').on('tap', '.prev-box-bg', function(){
			$('.prev-box').remove();
			$('.prev-box-bg').remove();
		});
	});
}

</script>
<script language="javascript">

function addInfomation(){
	var length = $('input[type="text"][name="navtitle[]"]').length;
	var html = '<div class="mui-card">'+
				'<div class="mui-card-content">'+
					'<div class="mui-input-row">'+
						'<label>栏目名称 <a href="javascript:;" onclick="addPic(' + length + ')">增加</a></label>'+
						'<input name="navtitle[]" type="text" placeholder="栏目标题：例如学校信息、老师信息" />'+
					'</div>'+
					'<div id="soninfo' + length + '"><div class="mui-card">'+
						'<div class="mui-card-content">'+
							'<div class="mui-input-row">'+
								'<label>上传图片</label>'+
								'<input type="file" name="img[' + length + '][]"/>'+
							'</div>'+
							'<div class="mui-input-row">'+
								'<label>图片标题</label>'+
								'<input type="text" name="imgtitle[' + length + '][]" placeholder="图片标题" maxlength="40" />'+
							'</div>'+
							'<div class="mui-input-row">'+
								'<label>图片描述</label>'+
								'<input type="text" name="imgbrief[' + length + '][]" placeholder="图片描述" maxlength="40" />'+
							'</div>'+
						'</div>'+
						'<div class="mui-card-footer">'+
							'<a class="mui-card-link" onclick="del(this);">删除信息</a>'+
						'</div>'+
					'</div>'+
				'</div>'+
				'<div class="mui-card-footer">'+
					'<a class="mui-card-link" onclick="del(this);">删除栏目</a>'+
				'</div>'+
			'</div>'+
			'</div>';
	$('#infomation').append(html);
}

function addPic(length){
	var html = '<div class="mui-card">'+
					'<div class="mui-card-content">'+
						'<div class="mui-input-row">'+
							'<label>上传图片</label>'+
							'<input type="file" name="img['+length+'][]"/>'+
						'</div>'+
						'<div class="mui-input-row">'+
							'<label>图片标题</label>'+
							'<input type="text" name="imgtitle['+length+'][]" placeholder="图片标题" maxlength="40" />'+
						'</div>'+
						'<div class="mui-input-row">'+
							'<label>图片描述</label>'+
							'<input type="text" name="imgbrief['+length+'][]" placeholder="图片描述" maxlength="40" />'+
						'</div>'+
					'</div>'+
					'<div class="mui-card-footer">'+
						'<a class="mui-card-link" onclick="del(this);">删除信息</a>'+
					'</div>'+
				'</div>';
	$('#soninfo' + length).append(html);
}

function del(obj){
	$(obj).parent().parent().remove();
}

function setAdImg(){
	var adimg = [];
	$('.imgListprocess').each(function(){
		if($(this).text() != ''){
			adimg.push($(this).text());
		}
	});

	$('#adimg').val(adimg.join(','));

	$('#brandFrom').submit();
	return false;
}
</script>
